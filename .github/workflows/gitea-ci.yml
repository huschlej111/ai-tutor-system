name: Gitea CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  security-scans:
    name: Security Scans
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        run: |
          python3 --version
          pip3 --version

      - name: Install security tools
        run: |
          pip3 install --break-system-packages --ignore-installed bandit checkov pip-audit
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

      - name: Create security reports directory
        run: mkdir -p security-reports

      - name: Run Bandit SAST
        run: |
          bandit -r src/ infrastructure/ scripts/ \
            -f json -o security-reports/bandit-report.json \
            --severity-level medium --confidence-level medium || true
        continue-on-error: true

      - name: Run Checkov Infrastructure Scan
        run: |
          checkov -d infrastructure/ \
            --output json --output-file-path security-reports || true
        continue-on-error: true

      - name: Run TruffleHog Secrets Scan
        run: |
          trufflehog filesystem . \
            --json --no-update > security-reports/trufflehog-report.json || true
        continue-on-error: true

      - name: Run pip-audit Dependency Scan
        run: |
          pip-audit --format json \
            --output security-reports/pip-audit-report.json \
            --desc --progress-spinner off || true
        continue-on-error: true

      - name: Show Security Reports
        run: |
          echo "=== Bandit SAST Report ==="
          cat security-reports/bandit-report.json | head -50 || echo "No Bandit report"
          echo ""
          echo "=== Checkov Infrastructure Scan ==="
          cat security-reports/results_json.json | head -50 || echo "No Checkov report"
          echo ""
          echo "=== TruffleHog Secrets Scan ==="
          cat security-reports/trufflehog-report.json | head -50 || echo "No TruffleHog report"
          echo ""
          echo "=== pip-audit Dependency Scan ==="
          cat security-reports/pip-audit-report.json | head -50 || echo "No pip-audit report"
        continue-on-error: true

  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: tutor_system_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        run: |
          python3 --version
          pip3 --version

      - name: Install dependencies
        run: |
          pip3 install --break-system-packages --ignore-installed -r requirements.txt
          pip3 install --break-system-packages --ignore-installed pytest pytest-cov pytest-xdist

      - name: Set up test environment
        run: |
          apt-get update && apt-get install -y postgresql-client

      - name: Run database migrations
        run: |
          export DATABASE_URL="postgresql://testuser:testpassword@localhost:5433/tutor_system_test"
          psql $DATABASE_URL -f src/lambda_functions/migration_runner/migrations/schema_v2.sql

      - name: Run backend tests
        run: |
          export DATABASE_URL="postgresql://testuser:testpassword@localhost:5433/tutor_system_test"
          export PYTHONPATH="${PYTHONPATH}:$(pwd)/src"
          pytest tests/ -v --cov=src --cov-report=term-missing

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        run: |
          curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
          apt-get install -y nodejs
          node --version
          npm --version

      - name: Build frontend
        env:
          VITE_API_URL: https://api.example.com
          VITE_USER_POOL_ID: us-east-1_EXAMPLE
          VITE_USER_POOL_CLIENT_ID: example123
          VITE_NODE_ENV: production
        run: |
          cd frontend
          npm ci
          npm run build

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [security-scans, test-backend, build-frontend]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "Security Scans: ${{ needs.security-scans.result }}"
          echo "Backend Tests: ${{ needs.test-backend.result }}"
          echo "Frontend Build: ${{ needs.build-frontend.result }}"
