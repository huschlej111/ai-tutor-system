name: GitHub CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  security-scans:
    name: Security Scans
    runs-on: ubuntu-latest
    # Only runs on GitHub Actions â€” Gitea uses .github/workflows/gitea-ci.yml instead

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: |
          pip install bandit checkov pip-audit
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

      - name: Create security reports directory
        run: mkdir -p security-reports

      - name: Run Bandit SAST
        run: |
          bandit -r src/ infrastructure/ scripts/ \
            -f json -o security-reports/bandit-report.json \
            --severity-level medium --confidence-level medium
        continue-on-error: true

      - name: Run Checkov Infrastructure Scan
        run: |
          checkov -d infrastructure/ \
            --output json --output-file-path security-reports
        continue-on-error: true

      - name: Run TruffleHog Secrets Scan
        run: |
          trufflehog filesystem . \
            --json --no-update > security-reports/trufflehog-report.json
        continue-on-error: true

      - name: Run pip-audit Dependency Scan
        run: |
          pip-audit --format json \
            --output security-reports/pip-audit-report.json \
            --desc --progress-spinner off
        continue-on-error: true

      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: security-reports/
          retention-days: 30

  validate-infrastructure:
    name: Validate Infrastructure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install CDK CLI
        run: npm install -g aws-cdk

      - name: Install Python dependencies
        run: |
          cd infrastructure
          pip install -r requirements.txt

      - name: Build frontend
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_COGNITO_USER_POOL_ID: ${{ secrets.VITE_COGNITO_USER_POOL_ID }}
          VITE_COGNITO_USER_POOL_CLIENT_ID: ${{ secrets.VITE_COGNITO_USER_POOL_CLIENT_ID }}
          VITE_AWS_REGION: us-east-1
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Validate CDK synth
        run: |
          cd infrastructure
          cdk synth --app "python app_multistack.py" --all

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: tutor_system_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-xdist

      - name: Run database migrations
        run: |
          export DATABASE_URL="postgresql://testuser:testpassword@localhost:5432/tutor_system_test"
          psql $DATABASE_URL -f src/lambda_functions/migration_runner/migrations/schema_v2.sql

      - name: Run backend tests
        run: |
          export DATABASE_URL="postgresql://testuser:testpassword@localhost:5432/tutor_system_test"
          export PYTHONPATH="${PYTHONPATH}:$(pwd)/src"
          pytest tests/ -v --cov=src --cov-report=term-missing

  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: [security-scans, validate-infrastructure, test-backend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install CDK CLI
        run: npm install -g aws-cdk

      - name: Install Python dependencies
        run: |
          cd infrastructure
          pip install -r requirements.txt

      - name: Build frontend for CDK asset
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_COGNITO_USER_POOL_ID: ${{ secrets.VITE_COGNITO_USER_POOL_ID }}
          VITE_COGNITO_USER_POOL_CLIENT_ID: ${{ secrets.VITE_COGNITO_USER_POOL_CLIENT_ID }}
          VITE_AWS_REGION: us-east-1
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy all stacks
        run: |
          cd infrastructure
          cdk deploy --app "python app_multistack.py" --all --require-approval never

      - name: Get stack outputs
        run: |
          cd infrastructure
          cdk deploy --app "python app_multistack.py" --all --outputs-file outputs.json
          cat outputs.json

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [deploy]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Run integration tests
        run: |
          # Add integration test commands here
          echo "Integration tests would run here"
