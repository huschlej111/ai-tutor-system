name: Security Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  security-scan:
    name: Security Analysis
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write
      actions: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for TruffleHog
    
    - name: Set up Python
      run: |
        python3 --version
        apt-get update && apt-get install -y python3-pip
        pip3 --version
    
    - name: Install dependencies
      run: |
        pip install --break-system-packages -r requirements.txt
        pip install --break-system-packages bandit checkov pip-audit
    
    - name: Install TruffleHog
      run: |
        curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin
    
    - name: Create security reports directory
      run: mkdir -p security-reports
    
    - name: Run Bandit SAST
      run: |
        bandit -r src/ infrastructure/ scripts/ \
          -f json -o security-reports/bandit-report.json \
          --severity-level medium --confidence-level medium || true
      continue-on-error: true
    
    - name: Run Checkov Infrastructure Scan
      run: |
        checkov -d infrastructure/ \
          --output json --output-file-path security-reports || true
      continue-on-error: true
    
    - name: Run TruffleHog Secrets Scan
      run: |
        trufflehog filesystem . \
          --json --no-update > security-reports/trufflehog-report.json || true
      continue-on-error: true
    
    - name: Run pip-audit Dependency Scan
      run: |
        pip-audit --format json \
          --output security-reports/pip-audit-report.json \
          --desc --progress-spinner off || true
      continue-on-error: true
    
    - name: Generate Security Summary
      run: python scripts/security_scan.py
      continue-on-error: true
    
    - name: Upload Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: security-reports/
        retention-days: 30
    
    # TODO: Re-enable for GitHub - these actions don't work on Gitea
    # - name: Upload Bandit SARIF
    #   uses: github/codeql-action/upload-sarif@v2
    #   if: always()
    #   with:
    #     sarif_file: security-reports/bandit-sarif.json
    #   continue-on-error: true
    
    # - name: Comment PR with Security Summary
    #   if: github.event_name == 'pull_request'
    #   uses: actions/github-script@v6
    #   with:
    #     script: |
    #       const fs = require('fs');
    #       try {
    #         const summary = JSON.parse(fs.readFileSync('security-reports/security-summary.json', 'utf8'));
    #         
    #         let comment = `## üîí Security Scan Results\n\n`;
    #         comment += `**Overall Status:** ${summary.overall_status === 'PASS' ? '‚úÖ PASS' : '‚ùå FAIL'}\n`;
    #         comment += `**Scan Time:** ${summary.scan_timestamp}\n\n`;
    #         
    #         comment += `### Tool Results\n`;
    #         for (const [tool, result] of Object.entries(summary.tools)) {
    #           const status = result.status === 'PASS' ? '‚úÖ' : '‚ùå';
    #           comment += `- **${tool}:** ${status} ${result.message}\n`;
    #         }
    #         
    #         if (summary.issues_found) {
    #           comment += `\n### üìã Recommendations\n`;
    #           for (const rec of summary.recommendations) {
    #             comment += `- ${rec}\n`;
    #           }
    #         }
    #         
    #         comment += `\nüìä Detailed reports are available in the workflow artifacts.`;
    #         
    #         github.rest.issues.createComment({
    #           issue_number: context.issue.number,
    #           owner: context.repo.owner,
    #           repo: context.repo.repo,
    #           body: comment
    #         });
    #       } catch (error) {
    #         console.log('Could not read security summary:', error.message);
    #       }
    
    - name: Fail on Security Issues
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        if [ -f security-reports/security-summary.json ]; then
          if grep -q '"overall_status": "FAIL"' security-reports/security-summary.json; then
            echo "‚ùå Security issues found in main branch"
            exit 1
          fi
        fi

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Dependency Review
      uses: actions/dependency-review-action@v3
      with:
        fail-on-severity: moderate
        allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC